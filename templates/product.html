{% extends "base.html" %}
{% block title %}{{ p.nombre }} · PokeTienda{% endblock %}
{% block content %}
<div class="grid md:grid-cols-2 gap-6">
  <div class="card bg-base-100 border border-base-300">
    <figure class="aspect-[4/3] bg-base-200">
      {% if p.image_url %}<img src="{{ p.image_url }}" alt="{{ p.nombre }}" class="object-contain w-full h-full">{% endif %}
    </figure>
  </div>
  <div class="space-y-3">
    <div class="badge badge-outline">Producto</div>
    <h1 class="text-2xl font-extrabold">{{ p.nombre }}</h1>
    <p class="opacity-70">{{ p.tipo }} · {{ p.categoria }}</p>
    <div class="flex flex-wrap gap-2">
      {% if p.rarity %}<div class="badge badge-outline">{{ p.rarity }}</div>{% endif %}
      {% if p.expansion %}<div class="badge badge-outline">{{ p.expansion }}</div>{% endif %}
      {% if p.language %}<div class="badge badge-outline">{{ p.language }}</div>{% endif %}
      {% if p.condition %}<div class="badge badge-outline">{{ p.condition }}</div>{% endif %}
    </div>

    <div class="text-3xl font-extrabold">
      ${{ "%.2f"|format(precio) }}
    </div>
    {% if razones and razones|length>0 %}
      <div class="text-xs opacity-70">Precio din&aacute;mico: {{ razones|join(', ') }}</div>
    {% endif %}

    <div class="flex gap-2 mt-2">
      <form method="post" action="{{ url_for('cart_add', pid=p.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="qty" value="1">
        <button class="btn btn-primary"><iconify-icon icon="mdi:cart"></iconify-icon> A&ntilde;adir al carrito</button>
      </form>
      <a href="{{ url_for('cart') }}" class="btn btn-outline">
        <iconify-icon icon="mdi:cart-outline"></iconify-icon> Ver carrito
      </a>
      {% if current_user.is_authenticated %}
        {% if in_wishlist %}
          <form method="post" action="{{ url_for('wishlist_remove', pid=p.id) }}"><input type="hidden" name="csrf_token" value="{{ csrf_token() }}"><button class="btn">Quitar de favoritos</button></form>
        {% else %}
          <form method="post" action="{{ url_for('wishlist_add', pid=p.id) }}"><input type="hidden" name="csrf_token" value="{{ csrf_token() }}"><button class="btn btn-outline">A&ntilde;adir a favoritos</button></form>
        {% endif %}
      {% endif %}
    </div>

    <details class="collapse collapse-arrow border border-base-300 rounded-box mt-3">
      <summary class="collapse-title text-base font-medium">Preg&uacute;ntale a la IA sobre este producto</summary>
      <div class="collapse-content">
        <form method="post" action="{{ url_for('ai_ask_product', pid=p.id) }}" class="flex gap-2 mt-2">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input class="input input-bordered w-full" name="q" placeholder="&iquest;Es edici&oacute;n limitada?">
          <button class="btn btn-primary">Preguntar</button>
        </form>
        {% if ai_q %}
          <div class="mt-3">
            <div class="badge badge-outline">Pregunta</div>
            <p class="mt-1">{{ ai_q }}</p>
            <div class="badge badge-outline mt-2">Respuesta</div>
            <p class="mt-1">{{ ai_answer }}</p>
          </div>
        {% endif %}
      </div>
    </details>

    <div class="prose max-w-none mt-3"><p>{{ p.descripcion }}</p></div>
  </div>
</div>

{% if recs and recs|length>0 %}
<h3 class="text-xl font-bold mt-6 mb-2">Tambi&eacute;n te puede interesar</h3>
<div class="grid gap-4 grid-cols-1 sm:grid-cols-2 md:grid-cols-4">
  {% for r in recs %}
  <div class="card bg-base-100 border border-base-300">
    <figure class="aspect-[4/3] bg-base-200">{% if r.image_url %}<img src="{{ r.image_url }}" alt="{{ r.nombre }}" class="object-cover w-full h-full">{% endif %}</figure>
    <div class="card-body p-4">
      <div class="card-title text-base">{{ r.nombre }}</div>
      <div class="opacity-70 text-sm">{{ r.tipo }} · {{ r.categoria }}</div>
      <div class="flex justify-between items-center mt-2">
        <div class="font-extrabold">${{ "%.2f"|format(r.precio_base) }}</div>
        <a class="btn btn-sm" href="{{ url_for('product_detail', pid=r.id) }}">Ver</a>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}

<h3 class="text-xl font-bold mt-6 mb-2">Rese&ntilde;as</h3>
<div class="grid md:grid-cols-2 gap-4">
  <div>
    {% if reviews and reviews|length>0 %}
      <ul class="space-y-2">
        {% for rv in reviews %}
        <li class="card bg-base-100 border border-base-300 p-3">
          <div class="font-bold">★ {{ rv.rating }}/5</div>
          <div class="opacity-70 text-sm">{{ rv.created_at }}</div>
          <p class="mt-1">{{ rv.comment }}</p>
        </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="alert alert-info">S&eacute; el primero en rese&ntilde;ar este producto.</div>
    {% endif %}
  </div>
  <div>
    {% if current_user.is_authenticated %}
      <form method="post" action="{{ url_for('post_review', pid=p.id) }}" class="card bg-base-100 border border-base-300 p-4 space-y-2">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <label class="form-control w-full">
          <div class="label"><span class="label-text">Puntuaci&oacute;n</span></div>
          <select name="rating" class="select select-bordered">
            {% for i in range(1,6) %}<option value="{{ i }}">{{ i }}</option>{% endfor %}
          </select>
        </label>
        <label class="form-control">
          <div class="label"><span class="label-text">Comentario</span></div>
          <textarea name="comment" class="textarea textarea-bordered" rows="3"></textarea>
        </label>
        <button class="btn btn-primary">Enviar</button>
      </form>
    {% else %}
      <div class="alert alert-info">Inicia sesi&oacute;n para dejar una rese&ntilde;a.</div>
    {% endif %}
  </div>
</div>
{% endblock %}