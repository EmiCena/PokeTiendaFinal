{% extends "base.html" %}
{% block title %}{{ p.nombre }} &middot; PokeShop{% endblock %}
{% block content %}
<div class="product">
  <img class="photo" src="{{ p.image_url }}" alt="{{ p.nombre }}">
  <div class="info">
    <h1>{{ p.nombre }}</h1>
    <div class="muted">Tipo: {{ p.tipo|capitalize }} &middot; Stock: {{ p.stock }}</div>

    {% if avg_rating %}
      <div class="stars">
        Valoraci&oacute;n:
        <span class="starline">
          {% set full = avg_rating|round(0, 'floor')|int %}
          {% for _ in range(full) %}&#9733;{% endfor %}
          {% for _ in range(5 - full) %}&#9734;{% endfor %}
        </span>
        <span class="muted">({{ avg_rating }}/5, {{ reviews|length }} rese&ntilde;as)</span>
      </div>
    {% else %}
      <div class="muted">A&uacute;n no hay rese&ntilde;as</div>
    {% endif %}

    <p>{{ p.descripcion }}</p>

    <div class="muted" style="margin:6px 0">
      {% if p.categoria and p.categoria|lower == 'tcg' %}
        <div><b>Metadatos TCG</b>:
          {% if p.expansion %} Expansi&oacute;n: {{ p.expansion }} &middot;{% endif %}
          {% if p.rarity %} Rareza: {{ p.rarity }} &middot;{% endif %}
          {% if p.language %} Idioma: {{ p.language }} &middot;{% endif %}
          {% if p.condition %} Condici&oacute;n: {{ p.condition }} &middot;{% endif %}
          {% if p.card_number %} N&ordm;: {{ p.card_number }}{% endif %}
        </div>
      {% endif %}
    </div>

    <div class="price">Precio para ti: <b>$ {{ "%.2f"|format(precio) }}</b></div>

    {# Precio de mercado si existe #}
    {% if p.market_price is not none %}
      <div class="box" style="margin-top:10px">
        <div class="muted">
          Precio de mercado: <b>$ {{ "%.2f"|format(p.market_price) }} {{ p.market_currency or 'USD' }}</b>
          {% if p.market_updated_at %} &middot; <span>Actualizado: {{ p.market_updated_at }}</span>{% endif %}
          {% if p.market_source %}<span class="chip">Fuente: {{ p.market_source }}</span>{% endif %}
        </div>
      </div>
    {% endif %}

    <form action="{{ url_for('cart_add', pid=p.id) }}" method="post" style="display:inline-block">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="number" name="qty" min="1" max="99" value="1">
      <button class="btn">A&ntilde;adir al carrito</button>
    </form>

    {% if current_user.is_authenticated %}
      {% if in_wishlist %}
        <form action="{{ url_for('wishlist_remove', pid=p.id) }}" method="post" style="display:inline-block">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button class="btn danger">Quitar &#x2764;&#xFE0F;</button>
        </form>
      {% else %}
        <form action="{{ url_for('wishlist_add', pid=p.id) }}" method="post" style="display:inline-block">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button class="btn">Guardar &#x2764;&#xFE0F;</button>
        </form>
      {% endif %}
    {% endif %}

    <details style="margin-top:8px">
      <summary>&iquest;C&oacute;mo se calcul&oacute; el precio?</summary>
      <ul>
        {% for r in razones %}<li>{{ r }}</li>{% endfor %}
      </ul>
      <code>{{ feats }}</code>
    </details>

    <hr style="margin:14px 0; border-color:#1a2450">

    <div class="box" style="margin:10px 0">
      <form method="post" action="{{ url_for('ai_ask_product', pid=p.id) }}" class="auth">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <label>Preg&uacute;ntale a la IA sobre este producto
          <textarea name="q" rows="2" placeholder="Ej: diferencias, usos, comparaci&oacute;n">{{ ai_q or '' }}</textarea>
        </label>
        <button class="btn">Preguntar</button>
      </form>
      {% if ai_answer %}
        <div class="muted" style="margin-top:6px"><b>Respuesta IA:</b> {{ ai_answer }}</div>
      {% endif %}
    </div>

    <h3>Rese&ntilde;as</h3>
    {% if current_user.is_authenticated %}
      <form method="post" action="{{ url_for('post_review', pid=p.id) }}" class="auth">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <label>Puntuaci&oacute;n
          <select name="rating">
            {% for i in range(1,6) %}
              <option value="{{i}}" {% if my_review and my_review.rating==i %}selected{% endif %}>{{i}}</option>
            {% endfor %}
          </select>
        </label>
        <label>Comentario
          <textarea name="comment" rows="3" placeholder="&iquest;Qu&eacute; te pareci&oacute;?">{{ my_review.comment if my_review else "" }}</textarea>
        </label>
        <button class="btn primary">Enviar rese&ntilde;a</button>
      </form>
    {% else %}
      <p class="muted">Inicia sesi&oacute;n para dejar tu rese&ntilde;a.</p>
    {% endif %}

    <ul>
      {% for r in reviews %}
        <li>
          <b>
            {% for _ in range(r.rating) %}&#9733;{% endfor %}
            {% for _ in range(5 - r.rating) %}&#9734;{% endfor %}
          </b>
          &mdash; {{ r.comment or "Sin comentario" }}
          <span class="muted">&middot; {{ r.created_at.strftime("%Y-%m-%d") }}</span>
          {% if r.user_id in purchasers %}<span class="chip">&#10004; Comprador verificado</span>{% endif %}
        </li>
      {% endfor %}
    </ul>
  </div>
</div>

{% if recs %}
  <h3 style="margin-top:14px">Tambi&eacute;n te puede gustar</h3>
  <div class="grid">
    {% for r in recs %}
    <a class="card" href="{{ url_for('product_detail', pid=r.id) }}">
      <img src="{{ r.image_url }}" alt="{{ r.nombre }}">
      <div class="title">{{ r.nombre }}</div>
      <div class="muted">Tipo: {{ r.tipo|capitalize }}</div>
      <div class="price">$ {{ "%.2f"|format(r.precio_base) }}</div>
    </a>
    {% endfor %}
  </div>
{% endif %}
{% endblock %}




